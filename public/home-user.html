<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Party Planner - Home (User)</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- CSP meta tag -->
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data:;"
    />
    <!-- Materialize CSS -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/main.css" />
  </head>
  <body>
    <div class="container">
      <h1>Welcome, User!</h1>
      <p>This is your home page for planning parties.</p>
      <a href="/logout" class="btn">Logout</a>

      <h3>Search for Vendors</h3>
      <form id="vendorSearchForm">
        <div class="input-field">
          <select id="searchService">
            <option value="" disabled selected>Select Service</option>
            <option value="Food">Food</option>
            <option value="Music">Music</option>
            <option value="Photos">Photos</option>
            <option value="Videos">Videos</option>
            <option value="Decorations">Decorations</option>
          </select>
          <label>Service</label>
        </div>
        <button type="submit" class="btn">Search</button>
      </form>

      <div id="vendorResults">
        <!-- Vendor search results will be populated here -->
      </div>

      <!-- Hidden reservation form -->
      <div
        id="reservationFormContainer"
        style="display: none; margin-top: 20px"
      >
        <h3>Make a Reservation</h3>
        <form id="reservationForm">
          <!-- Name: First and Last -->
          <div class="input-field">
            <input type="text" id="reservationName" required />
            <label for="reservationName">Name (First and Last)</label>
          </div>
          <!-- Date -->
          <div class="input-field">
            <input type="date" id="reservationDate" required />
            <label for="reservationDate">Date</label>
          </div>
          <!-- Time Dropdown -->
          <div class="input-field">
            <select id="reservationTime">
              <option value="" disabled selected>Select Time</option>
              <option value="09:00">09:00</option>
              <option value="09:30">09:30</option>
              <option value="10:00">10:00</option>
              <option value="10:30">10:30</option>
              <option value="11:00">11:00</option>
              <option value="11:30">11:30</option>
              <option value="12:00">12:00</option>
              <option value="12:30">12:30</option>
              <option value="13:00">13:00</option>
              <option value="13:30">13:30</option>
              <option value="14:00">14:00</option>
              <option value="14:30">14:30</option>
              <option value="15:00">15:00</option>
              <option value="15:30">15:30</option>
              <option value="16:00">16:00</option>
              <option value="16:30">16:30</option>
              <option value="17:00">17:00</option>
              <option value="17:30">17:30</option>
              <option value="18:00">18:00</option>
              <option value="18:30">18:30</option>
              <option value="19:00">19:00</option>
              <option value="19:30">19:30</option>
              <option value="20:00">20:00</option>
              <option value="20:30">20:30</option>
              <option value="21:00">21:00</option>
              <option value="21:30">21:30</option>
              <option value="22:00">22:00</option>
            </select>
            <label for="reservationTime">Time</label>
          </div>
          <!-- Location -->
          <div class="input-field">
            <input type="text" id="reservationLocation" required />
            <label for="reservationLocation">Location</label>
          </div>
          <!-- Additional Details -->
          <div class="input-field">
            <textarea
              id="reservationDetails"
              class="materialize-textarea"
            ></textarea>
            <label for="reservationDetails">Additional Details</label>
          </div>
          <!-- Hidden vendor field -->
          <input type="hidden" id="reservationVendor" />
          <button type="submit" class="btn">Submit Reservation</button>
          <button type="button" id="cancelReservation" class="btn red">
            Cancel
          </button>
        </form>
      </div>

      <h3>Your Reservation History</h3>
      <div id="reservationHistory">
        <!-- Reservation history will be populated here -->
      </div>
    </div>

    <!-- Materialize JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Initialize Materialize selects.
        const elems = document.querySelectorAll("select");
        M.FormSelect.init(elems);

        // Vendor search
        const vendorSearchForm = document.getElementById("vendorSearchForm");
        vendorSearchForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const service = document.getElementById("searchService").value;
          try {
            const response = await fetch(
              `/vendors?service=${encodeURIComponent(service)}`
            );
            const vendors = await response.json();
            const vendorResultsDiv = document.getElementById("vendorResults");
            if (vendors.length === 0) {
              vendorResultsDiv.innerHTML = "<p>No vendors found.</p>";
              return;
            }
            vendorResultsDiv.innerHTML = vendors
              .map((vendor) => {
                const info = vendor.vendorInfo || {};
                return `
                <div class="card">
                  <div class="card-content">
                    <span class="card-title">${info.companyName || "N/A"}</span>
                    <p>Service: ${info.service || "N/A"}</p>
                    <p>Average Cost: ${info.averageCost || "N/A"}</p>
                    <p>Description: ${info.description || ""}</p>
                    <p>Tags: ${info.tags ? info.tags.join(", ") : ""}</p>
                    <button class="btn reserve-btn" data-vendor="${
                      vendor.username
                    }">Make Reservation</button>
                  </div>
                </div>
              `;
              })
              .join("");
            document.querySelectorAll(".reserve-btn").forEach((btn) => {
              btn.addEventListener("click", () => {
                document.getElementById("reservationVendor").value =
                  btn.getAttribute("data-vendor");
                document.getElementById(
                  "reservationFormContainer"
                ).style.display = "block";
                M.FormSelect.init(document.querySelectorAll("select")); // reinitialize selects
              });
            });
          } catch (error) {
            console.error("Error searching vendors:", error);
          }
        });

        // Reservation form submission
        const reservationForm = document.getElementById("reservationForm");
        reservationForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const name = document.getElementById("reservationName").value;
          const date = document.getElementById("reservationDate").value;
          const time = document.getElementById("reservationTime").value;
          const location = document.getElementById("reservationLocation").value;
          const details = document.getElementById("reservationDetails").value;
          const vendor = document.getElementById("reservationVendor").value;
          if (!time) {
            alert("Please select a time.");
            return;
          }
          try {
            const response = await fetch("/reservations", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                name,
                date,
                time,
                location,
                details,
                vendor,
              }),
            });
            const data = await response.json();
            alert(data.message);
            reservationForm.reset();
            document.getElementById("reservationFormContainer").style.display =
              "none";
            loadReservationHistory();
          } catch (error) {
            console.error("Reservation error:", error);
          }
        });

        // Cancel reservation form
        document
          .getElementById("cancelReservation")
          .addEventListener("click", () => {
            reservationForm.reset();
            document.getElementById("reservationFormContainer").style.display =
              "none";
          });

        // Load user reservation history
        async function loadReservationHistory() {
          try {
            const response = await fetch("/user-reservations");
            const reservations = await response.json();
            const historyDiv = document.getElementById("reservationHistory");
            if (reservations.length === 0) {
              historyDiv.innerHTML = "<p>No reservations made.</p>";
              return;
            }
            historyDiv.innerHTML = reservations
              .map(
                (r) => `
              <div class="card">
                <div class="card-content">
                  <span class="card-title">${r.name}</span>
                  <p>Date: ${new Date(r.date).toLocaleDateString()}</p>
                  <p>Time: ${r.time}</p>
                  <p>Location: ${r.location}</p>
                  <p>Details: ${r.details || ""}</p>
                  <p>Status: ${r.status}</p>
                  ${
                    r.status === "pending"
                      ? `<button class="btn cancel-btn" data-id="${r._id}">Cancel Reservation</button>`
                      : ""
                  }
                </div>
              </div>
            `
              )
              .join("");
            document.querySelectorAll(".cancel-btn").forEach((btn) => {
              btn.addEventListener("click", async () => {
                const resId = btn.getAttribute("data-id");
                try {
                  const resp = await fetch(`/reservations/${resId}/cancel`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                  });
                  const result = await resp.json();
                  alert(result.message);
                  loadReservationHistory();
                } catch (err) {
                  console.error("Error canceling reservation:", err);
                }
              });
            });
          } catch (error) {
            console.error("Error fetching reservation history:", error);
          }
        }
        // Load reservation history on page load.
        loadReservationHistory();
      });
    </script>
  </body>
</html>
